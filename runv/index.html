<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LumiTrace Playground</title>
  <meta name="description" content="Run Ruby in the browser and see traced values inline with lumitrace 0.3.1.">
  <meta property="og:title" content="LumiTrace Playground">
  <meta property="og:description" content="Run Ruby in the browser and see traced values inline with lumitrace 0.3.1.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://github.com/ko1/lumitrace/tree/master/runv">
  <meta property="og:see_also" content="https://github.com/ko1/lumitrace/tree/master/runv">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.11.1/build/styles/github.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@500;700&family=IBM+Plex+Mono:wght@400;600&family=Work+Sans:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.11.1/build/highlight.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.11.1/build/languages/ruby.min.js"></script>
  <style>
    :root {
      --bg: #f3efe6;
      --panel: #ffffff;
      --ink: #1e1d1b;
      --accent: #cf4a2c;
      --muted: #6f6a62;
      --line: #d9d1c6;
      --ok: #1f7a4f;
      --bad: #a6362a;
      --editor-min: clamp(120px, 24vh, 320px);
      --output-min: clamp(120px, 20vh, 160px);
      --annotated-min: clamp(200px, 38vh, 360px);
      --mono: "IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      --display: "Fraunces", "Georgia", serif;
      --sans: "Work Sans", system-ui, -apple-system, "Segoe UI", sans-serif;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 24px;
      font-family: var(--sans);
      color: var(--ink);
      background:
        radial-gradient(circle at 12% 15%, rgba(207,74,44,0.12), transparent 40%),
        radial-gradient(circle at 85% 10%, rgba(31,122,79,0.12), transparent 45%),
        linear-gradient(180deg, #f8f5ef 0%, #efe9df 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 18px;
      border-bottom: 2px solid var(--line);
      padding-bottom: 10px;
    }

    h1 {
      font-family: var(--display);
      font-size: 30px;
      margin: 0;
      letter-spacing: 0.4px;
    }

    .sub {
      color: var(--muted);
      font-size: 14px;
      margin: 0;
    }

    .site-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding-top: 8px;
      border-top: 1px solid var(--line);
      margin-top: 12px;
    }

    .footer-links {
      display: flex;
      align-items: center;
      gap: 16px;
      color: var(--muted);
      font-size: 12px;
    }

    .wrap {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      align-items: stretch;
      flex: 1;
      min-height: 0;
    }

    .column {
      display: flex;
      flex-direction: column;
      gap: 24px;
      min-height: 0;
    }

    .column .panel {
      flex: 1;
      min-height: 0;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 12px 32px rgba(30, 29, 27, 0.08);
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 0;
    }

    .panel-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .annotated-frame {
      width: 100%;
      border: 1px dashed var(--line);
      border-radius: 10px;
      min-height: var(--annotated-min);
      flex: 1;
      background: #fbfaf7;
    }

    .status {
      font-size: 12px;
      color: var(--muted);
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 4px 10px;
      background: #f6f1e7;
    }

    .status.ok { color: var(--ok); border-color: rgba(31,122,79,0.3); }
    .status.bad { color: var(--bad); border-color: rgba(166,54,42,0.3); }

    textarea {
      width: 100%;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 12px;
      font-family: var(--mono);
      font-size: 13px;
      background: #fbfaf7;
      color: var(--ink);
      line-height: 1.5;
      resize: vertical;
    }

    .code-editor {
      position: relative;
      width: 100%;
      flex: 1;
      min-height: var(--editor-min);
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fbfaf7;
      overflow: hidden;
    }

    .code-editor pre {
      position: absolute;
      inset: 0;
      margin: 0;
      padding: 12px;
      font-family: var(--mono);
      font-size: 13px;
      line-height: 1.5;
      white-space: pre;
      overflow: auto;
    }

    .code-editor textarea {
      position: relative;
      width: 100%;
      height: 100%;
      min-height: 0;
      border: none;
      background: transparent;
      color: transparent;
      caret-color: var(--ink);
      resize: none;
      overflow: auto;
    }

    .editor {
      flex: 1;
      min-height: var(--editor-min);
    }

    .stdin {
      min-height: 90px;
    }

    .controls {
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: flex-end;
      flex-shrink: 0;
      margin-top: auto;
    }

    button {
      border: 1px solid var(--accent);
      background: var(--accent);
      color: #fff;
      padding: 8px 18px;
      border-radius: 999px;
      font-size: 13px;
      cursor: pointer;
      font-weight: 600;
      letter-spacing: 0.2px;
    }

    button:disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }

    .output-block {
      border: 1px dashed var(--line);
      border-radius: 10px;
      padding: 12px;
      background: #fbfaf7;
      font-family: var(--mono);
      font-size: 12px;
      white-space: pre-wrap;
      min-height: var(--output-min);
      flex: 1;
      overflow: auto;
    }

    .label {
      font-weight: 600;
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    @media (max-width: 900px) {
      .wrap {
        grid-template-columns: 1fr;
        flex: 0 0 auto;
      }
      .panel {
        min-height: auto;
      }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>LumiTrace Playground</h1>
      <p class="sub">Run Ruby in the browser and see traced values inline with lumitrace 0.3.1.</p>
    </div>
  </header>

  <main class="wrap">
    <section class="column">
      <section class="panel">
        <div class="panel-head">
          <div class="label">Editor</div>
          <span class="status" id="runStatus">Idle</span>
        </div>
        <div class="code-editor editor">
        <pre id="rubyHighlight" class="hljs"></pre>
        <textarea id="rubyInput" spellcheck="false">def square(n)
  if n > 0
    n > 0 ? n * n : raise
  else
    n
  end
end

def sum_of_squares(limit)
  total = 0
  (1..limit).each do |i|
    total += square(i)
  end
  total
end

def report(limit)
  puts "Squares:"
  (1..limit).each do |i|
    puts "  #{i}^2 = #{square(i)}"
  end
  puts "Sum: #{sum_of_squares(limit)}"
end

report(5)</textarea>
      </div>

        <div class="controls">
          <button id="runBtn" type="button" title="Ctrl/Cmd+Enter">Run</button>
        </div>
      </section>

      <section class="panel">
        <div class="panel-head">
          <div class="label">Output</div>
          <span class="status" id="runtimeStatus">Ready</span>
        </div>
        <div id="outputView" class="output-block"></div>
      </section>
    </section>

    <section class="panel">
      <div class="panel-head">
        <div class="label">Annotated</div>
      </div>
      <iframe
        id="annotatedFrame"
        class="annotated-frame"
        title="Lumitrace Annotated Output"
      ></iframe>
    </section>
  </main>

  <footer class="site-footer">
    <div class="footer-status">
      <span id="rubyStatus" class="status">Ruby.wasm loading</span>
    </div>
    <div class="footer-links">
      <span>Copyright (c) 2026 Koichi Sasada</span>
      <span><a href="https://github.com/ko1/lumitrace/tree/master/runv">(Repository)</a></span>
    </div>
  </footer>

  <script>
    const rubyStatus = document.getElementById('rubyStatus');
    if (window.location.protocol === 'file:') {
      rubyStatus.textContent = 'file:// からの実行は CORS 制限で失敗します。ローカルサーバで開いてください。';
      rubyStatus.className = 'status bad';
    }
    window.addEventListener('keydown', (event) => {
      if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
        event.preventDefault();
        const runBtn = document.getElementById('runBtn');
        if (runBtn) runBtn.click();
      }
    });

    const rubyInput = document.getElementById('rubyInput');
    const rubyHighlight = document.getElementById('rubyHighlight');
    const updateRubyHighlight = () => {
      if (!rubyInput || !rubyHighlight) return;
      const code = rubyInput.value || '';
      if (window.hljs) {
        rubyHighlight.innerHTML = hljs.highlight(code, { language: 'ruby' }).value;
      } else {
        rubyHighlight.textContent = code;
      }
    };
    if (rubyInput && rubyHighlight) {
      rubyInput.addEventListener('input', updateRubyHighlight);
      rubyInput.addEventListener('scroll', () => {
        rubyHighlight.scrollTop = rubyInput.scrollTop;
        rubyHighlight.scrollLeft = rubyInput.scrollLeft;
      });
      updateRubyHighlight();
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/@ruby/4.0-wasm-wasi@2.8.1/dist/browser.script.iife.js"></script>
  <script type="text/ruby">
    require "js"
    require "stringio"

    doc = JS.global[:document]
    ruby_input = doc.call(:getElementById, "rubyInput")
    run_btn = doc.call(:getElementById, "runBtn")
    run_status = doc.call(:getElementById, "runStatus")
    runtime_status = doc.call(:getElementById, "runtimeStatus")
    ruby_status = doc.call(:getElementById, "rubyStatus")
    output_view = doc.call(:getElementById, "outputView")
    annotated_frame = doc.call(:getElementById, "annotatedFrame")

    if ruby_input.nil? || run_btn.nil? || run_status.nil? ||
       runtime_status.nil? || ruby_status.nil? || output_view.nil? || annotated_frame.nil?
      JS.global[:console].call(:error, "Ruby UI elements not found")
      return
    end

    ruby_status[:textContent] = "Ruby.wasm #{RUBY_VERSION} ready"
    ruby_status[:className] = "status ok"

    orig_stdout = $stdout
    orig_stderr = $stderr
    orig_stdin = $stdin

    fetch_text = lambda do |path|
      response = JS.global[:fetch].call(path).await
      unless response[:ok]
        raise "failed to load #{path} (status=#{response[:status]})"
      end
      response.call(:text).await.to_s
    end

    strip_record_require = lambda do |code|
      code.gsub(/^\s*require_relative\s+["']record_instrument["']\s*$\n?/, "")
    end

    ensure_lumitrace = lambda do
      return if defined?(Lumitrace::RecordInstrument) && defined?(Lumitrace::GenerateResultedHtml)

      record_code = fetch_text.call("../lib/lumitrace/record_instrument.rb")
      eval(record_code, TOPLEVEL_BINDING, "lumitrace/record_instrument.rb")

      html_code = fetch_text.call("../lib/lumitrace/generate_resulted_html.rb")
      html_code = strip_record_require.call(html_code)
      eval(html_code, TOPLEVEL_BINDING, "lumitrace/generate_resulted_html.rb")

      Lumitrace.define_singleton_method(:R) do |id, value|
        Lumitrace::RecordInstrument.record_history(id, value)
      end
      Lumitrace::RecordInstrument.collect_mode = :history
    end

    set_status = lambda do |node, text, kind = nil|
      node[:textContent] = text
      node[:className] = kind ? "status #{kind}" : "status"
    end

    run_code = lambda do
      run_btn[:disabled] = true
      set_status.call(run_status, "Running...")
      set_status.call(runtime_status, "Executing...")
      output_view[:textContent] = ""

      out = StringIO.new
      err = StringIO.new
      input = StringIO.new("")
      source = ruby_input[:value].to_s
      annotated_html = ""

      begin
        $stdout = out
        $stderr = err
        $stdin = input

        Object.send(:remove_const, :STDIN) if Object.const_defined?(:STDIN)
        Object.send(:remove_const, :STDOUT) if Object.const_defined?(:STDOUT)
        Object.send(:remove_const, :STDERR) if Object.const_defined?(:STDERR)
        STDIN = $stdin
        STDOUT = $stdout
        STDERR = $stderr

        ensure_lumitrace.call
        Lumitrace::RecordInstrument.reset_events!
        Lumitrace::RecordInstrument.instance_variable_set(:@loc_by_id, [])
        Lumitrace::RecordInstrument.instance_variable_set(:@next_id, 0)
        instrumented = Lumitrace::RecordInstrument.instrument_source(source, [], file_label: "script.rb")
        eval(instrumented, TOPLEVEL_BINDING, "script.rb")
      rescue Exception => e
        err.puts("#{e.class}: #{e.message}")
        if e.backtrace
          err.puts(e.backtrace.join("\\n"))
        end
      ensure
        combined = out.string
        combined += err.string if err.string && err.string != ""
        output_view[:textContent] = combined
        begin
          events = Lumitrace::RecordInstrument.events
          annotated_html = Lumitrace::GenerateResultedHtml.render_source_from_events(
            source,
            events,
            filename: "script.rb",
            collect_mode: "history",
            max_samples: Lumitrace::RecordInstrument.max_samples_per_expr
          )
        rescue Exception => e
          annotated_html = "<pre>Annotated render error: #{e.class}: #{e.message}</pre>"
        end
        annotated_frame[:srcdoc] = annotated_html

        $stdout = orig_stdout
        $stderr = orig_stderr
        $stdin = orig_stdin

        Object.send(:remove_const, :STDIN) if Object.const_defined?(:STDIN)
        Object.send(:remove_const, :STDOUT) if Object.const_defined?(:STDOUT)
        Object.send(:remove_const, :STDERR) if Object.const_defined?(:STDERR)
        STDIN = orig_stdin
        STDOUT = orig_stdout
        STDERR = orig_stderr
      end

      set_status.call(run_status, "Done", "ok")
      set_status.call(runtime_status, "Finished", "ok")
      run_btn[:disabled] = false
    end

    run_btn.call(:addEventListener, "click") { run_code.call }
  </script>

  <script>
    const annotatedFrame = document.getElementById('annotatedFrame');
    if (annotatedFrame) {
      annotatedFrame.addEventListener('load', () => {
        try {
          const doc = annotatedFrame.contentDocument;
          if (!doc) return;
          const clearActive = () => {
            doc.querySelectorAll('.expr.active').forEach(e => e.classList.remove('active'));
          };
          doc.querySelectorAll('.marker').forEach(marker => {
            marker.addEventListener('mouseenter', () => {
              clearActive();
              const expr = marker.closest('.expr');
              if (expr) expr.classList.add('active');
            });
            marker.addEventListener('mouseleave', () => {
              const expr = marker.closest('.expr');
              if (expr) expr.classList.remove('active');
            });
          });
        } catch (_) {
          // Cross-origin or iframe not ready.
        }
      });
    }
  </script>
</body>
</html>
