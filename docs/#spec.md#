# Lumitrace Spec

## Overview

Lumitrace instruments Ruby source code at load time (via `RubyVM::InstructionSequence.translate` when available), records expression results, and renders an HTML view that overlays recorded values on your code. It is designed for local “what happened here?” inspection.

## Goals

- Record expression results with minimal friction.
- Limit recorded data size (keep only the last N values per expression).
- Show recorded values inline on a per-file HTML view.
- Support require-time instrumentation for multiple files.

## Non-Goals

- Production-safe tracing.
- Perfect semantic preservation for all Ruby edge cases.

## Library API

### `require "lumitrace"`

- Arguments: none.
- Returns: nothing.
- Side effects: loads core code only (no instrumentation, no `at_exit`).

### `Lumitrace.enable!(max_values: nil, ranges_by_file: nil, root: nil, at_exit: true)`

- Arguments:
  - `max_values`: integer or nil. Sets maximum values stored per expression.
  - `ranges_by_file`: hash or nil. `{ "/path/to/file.rb" => [1..5, 10..12] }`.
  - `at_exit`: boolean. When true, registers HTML output at exit.
- Returns: `nil`.
- Side effects:
  - Loads `record_require` if needed and enables require-time instrumentation.
  - Registers a single `at_exit` hook (if `at_exit: true`).
  - Fixes the HTML output directory to the `Dir.pwd` at call time.

### `Lumitrace.disable!`

- Arguments: none.
- Returns: `nil`.
- Side effects: disables instrumentation (does not clear recorded events).

### `Lumitrace.dump!(path = nil)`

- Arguments:
  - `path`: string or nil. Output JSON path when provided.
- Returns: the path used.
- Side effects: writes JSON to disk immediately.

### `require "lumitrace/enable"`

- Arguments: none.
- Returns: nothing.
- Side effects: calls `Lumitrace.enable!` with default arguments.

### `require "lumitrace/enable_git_diff"`

- Arguments: none.
- Returns: nothing.
- Side effects:
  - Computes `ranges_by_file` from `git diff` scoped to the current program file.
  - Calls `Lumitrace.enable!` when diff is non-empty.

Environment variables for `enable_git_diff`:

- `LUMITRACE_GIT_DIFF=working|staged|base:REV|range:SPEC` selects diff source.
- `LUMITRACE_GIT_DIFF_CONTEXT=N` expands hunks by +/-N lines (default 3; negative treated as 0).
- `LUMITRACE_GIT_CMD` overrides the git executable (default: `git`).

### `RecordRequire.enable(max_values: nil, ranges_by_file: nil, root: nil)`

- Arguments:
  - `max_values`: integer or nil. Sets maximum values stored per expression.
  - `ranges_by_file`: hash or nil. `{ "/path/to/file.rb" => [1..5, 10..12] }`.
- Returns: `nil`.
- Side effects: enables require-time instrumentation immediately.

### `RecordInstrument.instrument_source(src, ranges, file_label: nil, record_method: "Lumitrace::RecordInstrument.expr_record")`

- Arguments:
  - `src`: string. Ruby source.
  - `ranges`: array of `[start_line, end_line]` pairs.
  - `file_label`: string or nil. File label to record into events.
  - `record_method`: string. Wrapper method name.
- Returns: rewritten Ruby source as a string.
- Side effects: none.

### `RecordInstrument.expr_record(file, start_line, start_col, end_line, end_col, value)`

- Arguments: expression location and value.
- Returns: `value`.
- Side effects: appends value into the in-memory event store and updates totals.

### `RecordInstrument.dump_json(path = default)`

- Arguments:
  - `path`: string or nil. When nil, defaults to `Dir.pwd/lumitrace_recorded.json`.
- Returns: the path used.
- Side effects: writes JSON to disk.

### `RecordInstrument.events`

- Arguments: none.
- Returns: array of event hashes.
- Side effects: none.

### `RecordInstrument.max_values_per_expr` / `max_values_per_expr=`

- Arguments: none / integer.
- Returns: current max values per expression.
- Side effects: setter changes recording limit.

### `GenerateResultedHtml.render(source_path, events_path, ranges: nil)`

- Arguments:
  - `source_path`: file path.
  - `events_path`: JSON path.
  - `ranges`: array of `[start_line, end_line]` pairs or nil.
- Returns: HTML string.
- Side effects: none.

### `GenerateResultedHtml.render_all(events_path, root: Dir.pwd, ranges_by_file: nil)`

- Arguments:
  - `events_path`: JSON path.
  - `root`: root directory for file headings.
  - `ranges_by_file`: hash or nil.
- Returns: HTML string.
- Side effects: none.

### `GenerateResultedHtml.render_all_from_events(events, root: Dir.pwd, ranges_by_file: nil)`

- Arguments:
  - `events`: array of event hashes.
  - `root`: root directory for file headings.
  - `ranges_by_file`: hash or nil.
- Returns: HTML string.
- Side effects: none.

## Instrumentation

### Activation

- Require `lumitrace/record_require` and call `RecordRequire.enable`.
- Hook `RubyVM::InstructionSequence.translate` to rewrite files at load time.
- Only instrument files under the configured root directory.
- Optional: restrict instrumentation to specific line ranges per file.

### Root Scope

- Root is `root` if set, otherwise `ENV[LUMITRACE_ROOT]` if set, otherwise `Dir.pwd`.
- Files outside root are ignored.

### Exclusions

- Tool files are excluded to avoid self-instrumentation:
  - `record_instrument.rb`
  - `record_require.rb`
  - `generate_resulted_html.rb`

### Rewriting Strategy

- AST is parsed with Prism.
- For each node, if it matches “wrapable” expression classes, injects:
  - `RecordInstrument.expr_record(file, start_line, start_col, end_line, end_col, (expr))`
- Insertions are done by offset to preserve original formatting.

### Range Filtering

- `ranges_by_file` is a hash like `{ "/path/to/file.rb" => [1..5, 10..12] }`.
- When provided, only files listed in the hash are instrumented.
- For a listed file, only expressions whose start line falls within the listed ranges are instrumented.
- If a listed file has `nil` or an empty array for ranges, the entire file is instrumented.
- HTML rendering respects the same ranges and only shows the listed lines/files.

### Wrap Targets

- `CallNode` (except those with block bodies)
- Variable reads:
  - `LocalVariableReadNode`
  - `ConstantReadNode`
  - `InstanceVariableReadNode`
  - `ClassVariableReadNode`
  - `GlobalVariableReadNode`
- Literal nodes are excluded (e.g. integer, string, true/false, nil, etc.)

## Recording

- Results are stored per expression key:
  - `(file, start_line, start_col, end_line, end_col)`
- Keep only the last N values (`max_values_per_expr`, default 3).
- Track `total` count for how many times the expression executed.
- Values are stored via `inspect` for non-primitive types.
- String values are truncated to 1000 bytes for storage.

### Output JSON

`lumitrace_recorded.json` contains an array of entries:

```json
{
  "file": "/path/to/file.rb",
  "start_line": 10,
  "start_col": 4,
  "end_line": 10,
  "end_col": 20,
  "values": ["..."],
  "total": 123
}
```

## CLI

### `exe/lumitrace`

```
lumitrace FILE [--html PATH] [--json [PATH]] [--max N] [--range SPEC]
```

- HTML is rendered by default (from in-memory events; no JSON file is required).
- `--html` specifies the HTML output path.
- JSON is written only when `--json` is provided.
- `--json` writes JSON output (default: `lumitrace_recorded.json`).
- `--max` sets max values per expression.
- `--range` restricts instrumentation per file (`FILE` or `FILE:1-5,10-12`). Can be repeated.
- `LUMITRACE_VALUES_MAX` sets the default max values per expression.

## HTML Rendering

- `GenerateResultedHtml.render_all` renders all files in one page.
- Each file is shown in its own section.
- Expressions are marked with an inline icon.
- Hovering the icon shows recorded values.
- Only the last 3 values are shown in the tooltip; additional values are summarized as `... (+N more)`.
- Tooltip is scrollable horizontally for long values.

### Copy/Paste Behavior

- Inline icon uses a separate marker span to reduce copy/paste artifacts.
- Lines are rendered as inline spans with explicit `\n` inserted.

## Known Limitations

- Requires `RubyVM::InstructionSequence.translate` support in the Ruby build.
- Instrumentation is for debugging; semantics may change for unusual edge cases.
- Tool does not attempt to preserve file encoding comments.
