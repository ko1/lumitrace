#!/usr/bin/env ruby
# frozen_string_literal: true

require "rbconfig"
require_relative "../lib/lumitrace"

if ARGV.first == "help"
  ARGV.shift
  begin
    opts, parser = Lumitrace.parse_format_options(
      ARGV,
      banner: "usage: lumitrace help [--format text|json]"
    )
  rescue OptionParser::ParseError, ArgumentError => e
    warn e.message
    exit 1
  end
  if opts[:help]
    puts parser
    exit 0
  end
  puts Lumitrace.render_help(format: opts[:format])
  exit 0
end

if ARGV.first == "schema"
  ARGV.shift
  begin
    opts, parser = Lumitrace.parse_format_options(
      ARGV,
      banner: "usage: lumitrace schema [--format text|json]"
    )
  rescue OptionParser::ParseError, ArgumentError => e
    warn e.message
    exit 1
  end
  if opts[:help]
    puts parser
    exit 0
  end
  puts Lumitrace.render_schema(format: opts[:format])
  exit 0
end

opts, args, parser = Lumitrace.parse_cli_options(
  ARGV,
  banner: "usage: lumitrace [options] script.rb [ruby_opt] | lumitrace [options] exec CMD [args...] | lumitrace help [--format text|json] | lumitrace schema [--format text|json]",
  allow_help: true,
  order: :preserve
)
if opts[:help]
  puts parser
  exit 0
end

if args.empty?
  warn parser.to_s
  exit 1
end

if opts[:git_diff_mode] == "exec" && args.first != "exec"
  args.unshift("exec")
  opts[:git_diff_mode] = "working"
end

env = {}
env["LUMITRACE_ENABLE"] = "1"
env["LUMITRACE_TEXT"] = opts[:text] == true ? "1" : opts[:text] == false ? "0" : opts[:text].to_s if !opts[:text].nil?
env["LUMITRACE_HTML"] = opts[:html] == true ? "1" : opts[:html] == false ? "0" : opts[:html].to_s if !opts[:html].nil?
env["LUMITRACE_JSON"] = opts[:json] == true ? "1" : opts[:json] == false ? "0" : opts[:json].to_s if !opts[:json].nil?
env["LUMITRACE_MAX_SAMPLES"] = opts[:max_samples].to_s if opts[:max_samples]
env["LUMITRACE_COLLECT_MODE"] = opts[:collect_mode].to_s if opts[:collect_mode]
env["LUMITRACE_ROOT"] = opts[:root] if opts[:root]
env["LUMITRACE_VERBOSE"] = opts[:verbose].to_s if !opts[:verbose].nil?
if opts[:range_specs].any?
  env["LUMITRACE_RANGE"] = opts[:range_specs].join(";")
end
if opts[:git_diff_mode]
  env["LUMITRACE_GIT_DIFF"] = opts[:git_diff_mode]
end
if opts[:git_diff_context]
  env["LUMITRACE_GIT_DIFF_CONTEXT"] = opts[:git_diff_context].to_s
end
if opts[:git_cmd]
  env["LUMITRACE_GIT_CMD"] = opts[:git_cmd]
end
if opts[:git_diff_no_untracked]
  env["LUMITRACE_GIT_DIFF_UNTRACKED"] = "0"
end

lib_dir = File.expand_path("../lib", __dir__)
ruby_lib = ENV["RUBYLIB"].to_s
env["RUBYLIB"] = ([lib_dir] + ruby_lib.split(":")).uniq.join(":")

rubyopt = ENV["RUBYOPT"].to_s
unless rubyopt.split.any? { |t| t == "-rlumitrace" || t == "-rlumitrace/enable" }
  rubyopt = rubyopt.strip.empty? ? "-rlumitrace" : "#{rubyopt} -rlumitrace"
end
env["RUBYOPT"] = rubyopt

if args[0] == "exec"
  cmd = args[1..]
  if cmd.nil? || cmd.empty?
    warn "lumitrace exec: missing command"
    exit 1
  end
  exec(env, *cmd)
else
  script = args.shift
  exec(env, RbConfig.ruby, script, *args)
end
