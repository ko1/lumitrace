#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative "../lib/lumitrace"

opts, args, parser = Lumitrace.parse_cli_options(
  ARGV,
  banner: "usage: lumitrace FILE [options]",
  allow_help: true
)
if opts[:help]
  puts parser
  exit 0
end
path = args.shift or abort(parser.to_s)

opts[:root] = File.expand_path(opts[:root]) if opts[:root] && !opts[:root].strip.empty?
opts[:ranges_by_file] = Lumitrace.resolve_ranges_by_file(
  opts[:range_specs],
  git_diff_mode: opts[:git_diff_mode],
  git_diff_context: opts[:git_diff_context],
  git_cmd: opts[:git_cmd],
  git_diff_no_untracked: opts[:git_diff_no_untracked]
)

Lumitrace.enable!(
  max_values: opts[:max_values],
  ranges_by_file: opts[:ranges_by_file],
  root: opts[:root],
  text: opts[:text],
  html: opts[:html],
  json: opts[:json],
  verbose: opts[:verbose],
  at_exit: true
)
load File.expand_path(path)
