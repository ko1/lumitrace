#!/usr/bin/env ruby
# frozen_string_literal: true

require "json"
require_relative "../lib/lumitrace/record_require"
require_relative "../lib/lumitrace/generate_resulted_html"

args = ARGV.dup
path = args.shift or abort "usage: lumitrace FILE [--html [out.html]] [--max N]"
html_out = nil
max_values = nil
if args[0] == "--html"
  args.shift
  html_out = args.shift || File.join(File.dirname(path), "recorded.html")
end
if args[0] == "--max"
  args.shift
  max_values = args.shift
end
env_max = ENV["LUMITRACE_VALUES_MAX"]
max_values = env_max if max_values.nil? && env_max && !env_max.empty?

Lumitrace::RecordRequire.enable(max_values: max_values)
load File.expand_path(path)
json_path = File.expand_path("record_events.json", __dir__)
puts "recorded: #{json_path}"

if html_out
  html = Lumitrace::GenerateResultedHtml.render_all(json_path, root: File.dirname(File.expand_path(path)))
  File.write(html_out, html)
  puts "html: #{html_out}"
end
